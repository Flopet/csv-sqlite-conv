import csv
from ptest import *

class NewTable:
    def __init__(self, db):
        self.db = db
        self.columns = ""
        cursor = db.cursor

        ##################################################
        #   Get the field names from the CSV file and return
        #   them as a comma-separated string to be used in
        #   the SQL queries
        ##################################################
        attempt = 0
        while attempt < 3:
            try:
                self.csv = input("Enter the CSV file name: ") + ".csv"
                with open(self.csv) as file:
                    csvreader = csv.DictReader(file)
                    fields = csvreader.fieldnames

                    # Print the field names to the console
                    print(f"""
    Fields in CSV file: {fields}
                """)
                    
                    # Store modified column names for SQL queries
                    modified_fields = []
                    columns_with_types = ""

                    # Ask user for data types for each field
                    for field in fields:
                        column_type = input(f"Enter the data type for {field}: ").upper()
                        acceptable_types = ["TEXT", "INTEGER", "REAL"]
                        while column_type not in acceptable_types:
                            print(f"Invalid data type '{column_type}'. Please enter one of the following: {acceptable_types}")
                            column_type = input(f"Enter the data type for {field}: ").upper()
                        
                        # Modify field name: replace spaces with underscores and convert to lowercase
                        modified_field = field.replace(" ", "_").lower()
                        modified_fields.append(f'"{modified_field}"')
                        
                        columns_with_types += f'"{modified_field}" {column_type}, '
                    
                    # Store the comma-separated list of quoted column names
                    self.columns = ", ".join(modified_fields)
                    attempt = 4

            except FileNotFoundError:
                print(f"Error: File '{self.csv}' not found. Enter a filname, without the extension, from within this folder. Attempt {attempt+1}/3")
                attempt += 1
                if attempt == 3:
                    print("\nError: File not found. Exiting program.")
                    exit()

        ##################################################
        #   Generate a tablename based on the CSV filename and
        #   create a new table in the database with the fields
        #   specified in the CSV file.
        ##################################################
        # Get table name from CSV filename
        self.name = self.csv.split('.')[0]
        # Check if table already exists in database
        table_list = cursor.execute(f"SELECT name FROM sqlite_master WHERE type='table';").fetchall()
        table_list = [item for sublist in table_list for item in sublist] # Flatten list

        if table_list is not None:
            if self.name in table_list:
                ask = input(f"Table {self.name} already exists. Would you like to add to existing table? (y/n)").lower()
                while ask != "y" and ask != "n":
                    ask = input(f"Invalid input. Please enter 'y' or 'n'.").lower()
                if ask == "y":
                    cursor.execute(f"DROP TABLE {self.name};")
                elif ask == "n":
                    # If the table already exists and the user doesnt want
                    # to overwrite the current, ask user for a new table name.
                    new_name = input(f"What would you like to name this new table (lowercase with underscores)? ")
                    self.name = new_name

        # UNIQUE(col1, col2, col3, ...) Restricts the table to contain unique rows
        query = f"CREATE TABLE IF NOT EXISTS {self.name} ({columns_with_types}UNIQUE({self.columns}));"

        # Ask user if column types should be strictly enforced or not
        options = ["y", "n"]
        strict = input(f"\nDo you want to strictly enforce data types? (y/n): ").lower()
        if strict == options[0]:
            query = query[:-1] + " STRICT" + query[-1:]
        cursor.execute(query)

        print(f"\nCreated table {self.name} in database {db.name}.")
        db.commit()
